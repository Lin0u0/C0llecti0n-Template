---
import Layout from "../layouts/Layout.astro";
import DiscDrawer from "../components/DiscDrawer.astro";
import NavMenu from "../components/NavMenu.astro";
import FilterToggle from "../components/FilterToggle.astro";
import SortToggle from "../components/SortToggle.astro";
import StatusFilter from "../components/StatusFilter.astro";
import SearchButton from "../components/SearchButton.astro";
import moviesData from "../data/movies.json";
import seriesData from "../data/series.json";
import type { Movie, Series } from "../types";
import { extractFilterOptions, extractNumericOptions, getAddedYear } from "../utils/filters";

// Type assertion and combine
const movies: Movie[] = moviesData.map((m) => ({ ...m, type: "movie" as const }));
const series: Series[] = seriesData.map((s) => ({ ...s, type: "series" as const }));

const allMedia = [...movies, ...series].sort((a, b) => {
    const dateA = new Date(a.addedDate || "1970-01-01").getTime();
    const dateB = new Date(b.addedDate || "1970-01-01").getTime();
    if (dateA !== dateB) return dateB - dateA;
    return a.title.localeCompare(b.title);
});

// Extract filter options
const directors = extractFilterOptions(allMedia, (m) => m.director);
const years = extractNumericOptions(allMedia, (m) => m.year);
const countries = extractFilterOptions(allMedia, (m) => m.country);
const addedYears = [...new Set(allMedia.map((m) => getAddedYear(m.addedDate)))].filter(Boolean).sort((a, b) => Number(b) - Number(a));
---

<Layout
    title="Cinema | Lin0u0"
    description="Cinema Collection"
    totalCount={allMedia.length}
>
    <div class="page-container">
        <header class="page-header">
            <h1 class="page-title">Cinema</h1>
            <NavMenu currentPage="cinema" />
        </header>

        <div class="filters-section">
            <div class="filters-toolbar">
                <FilterToggle />
                <div class="toolbar-right">
                    <SearchButton />
                    <SortToggle showRating={true} />
                </div>
            </div>

            <div class="collapsible-filters" data-expanded="false">
                <div class="collapsible-inner">
                    <div class="filter-group">
                        <span class="filter-label">状态</span>
                        <StatusFilter type="media" />
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">类型</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="type"
                                data-value="all">全部</button
                            >
                            <button
                                class="filter-chip"
                                data-filter-type="type"
                                data-value="movie">电影</button
                            >
                            <button
                                class="filter-chip"
                                data-filter-type="type"
                                data-value="series">剧集</button
                            >
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">添加时间</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="added"
                                data-value="all">全部</button
                            >
                            {
                                addedYears.map((year) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="added"
                                        data-value={year}
                                    >
                                        {year}
                                    </button>
                                ))
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">上映年份</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="year"
                                data-value="all">全部</button
                            >
                            {
                                years.map((year) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="year"
                                        data-value={year}
                                    >
                                        {year}
                                    </button>
                                ))
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">导演</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="director"
                                data-value="all">全部</button
                            >
                            {
                                directors.map((director) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="director"
                                        data-value={director}
                                    >
                                        {director}
                                    </button>
                                ))
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">国家/地区</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="country"
                                data-value="all">全部</button
                            >
                            {
                                countries.map((country) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="country"
                                        data-value={country}
                                    >
                                        {country}
                                    </button>
                                ))
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="movies-grid">
            <DiscDrawer allMedia={allMedia} variant="grid" />
        </div>
    </div>
</Layout>

<script>
    import { initFilterSystem } from "../scripts/filter-system";

    initFilterSystem({
        itemSelector: ".disc-case",
        containerSelector: ".discs-container",
        statsDisplayId: "stats-display",
        filterTypes: ["type", "director", "year", "added", "country", "status"],
    });
</script>

<style>
    .filters-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-md);
    }

    .toolbar-right {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    /* 响应式poster大小调整 - 屏幕越小，海报越小 */
    @media (max-width: 768px) {
        :root {
            --disc-size: 110px;
        }
    }

    @media (max-width: 480px) {
        :root {
            --disc-size: 100px;
        }

        .filters-toolbar {
            flex-wrap: wrap;
            gap: var(--space-sm);
        }
    }

    @media (max-width: 360px) {
        :root {
            --disc-size: 90px;
        }
    }
</style>
