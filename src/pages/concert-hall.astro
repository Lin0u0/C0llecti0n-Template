---
import Layout from "../layouts/Layout.astro";
import RecordCabinet from "../components/RecordCabinet.astro";
import NavMenu from "../components/NavMenu.astro";
import FilterToggle from "../components/FilterToggle.astro";
import SortToggle from "../components/SortToggle.astro";
import SearchButton from "../components/SearchButton.astro";
import musicData from "../data/music.json";
import type { Album } from "../types";
import { extractFilterOptions, extractNumericOptions, getAddedYear } from "../utils/filters";

// Type assertion and sort
const albums: Album[] = musicData.map((item) => ({
    ...item,
})).sort(
    (a, b) =>
        new Date(b.addedDate || 0).getTime() -
        new Date(a.addedDate || 0).getTime(),
);

// Extract filter options
const artists = extractFilterOptions(albums, (a) => a.artist);
const years = extractNumericOptions(albums, (a) => a.year);
const countries = extractFilterOptions(albums, (a) => a.country);
const addedYears = [...new Set(albums.map((a) => getAddedYear(a.addedDate)))].filter(Boolean).sort((a, b) => Number(b) - Number(a));
---

<Layout
    title="Concert Hall | Lin0u0"
    description="Music Collection"
    totalCount={albums.length}
>
    <div class="page-container">
        <header class="page-header">
            <h1 class="page-title">Concert Hall</h1>
            <NavMenu currentPage="concert-hall" />
        </header>

        <div class="filters-section">
            <div class="filters-toolbar">
                <FilterToggle />
                <div class="toolbar-right">
                    <SearchButton />
                    <SortToggle showRating={false} />
                </div>
            </div>

            <div class="collapsible-filters" data-expanded="false">
                <div class="collapsible-inner">
                    <div class="filter-group">
                        <span class="filter-label">添加时间</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="added"
                                data-value="all">全部</button
                            >
                            {
                                addedYears.map((year) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="added"
                                        data-value={year}
                                    >
                                        {year}
                                    </button>
                                ))
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">发行年份</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="year"
                                data-value="all">全部</button
                            >
                            {
                                years.map((year) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="year"
                                        data-value={year}
                                    >
                                        {year}
                                    </button>
                                ))
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">艺术家</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="artist"
                                data-value="all">全部</button
                            >
                            {
                                artists.map((artist) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="artist"
                                        data-value={artist}
                                    >
                                        {artist}
                                    </button>
                                ))
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">国家/地区</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="country"
                                data-value="all">全部</button
                            >
                            {
                                countries.map((country) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="country"
                                        data-value={country}
                                    >
                                        {country}
                                    </button>
                                ))
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="music-grid">
            <RecordCabinet albums={albums} variant="grid" />
        </div>
    </div>
</Layout>

<script>
    import { initFilterSystem } from "../scripts/filter-system";

    initFilterSystem({
        itemSelector: ".vinyl-sleeve",
        containerSelector: ".records-container",
        statsDisplayId: "stats-display",
        filterTypes: ["artist", "year", "added", "country"],
    });
</script>

<style>
    .filters-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-md);
    }

    .toolbar-right {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        flex-shrink: 0;
    }

    /* 响应式封面大小调整 - 屏幕越小，封面越小 */
    @media (max-width: 768px) {
        :root {
            --vinyl-size: 140px;
        }
    }

    @media (max-width: 480px) {
        :root {
            --vinyl-size: 120px;
        }

        .filters-toolbar {
            gap: var(--space-sm);
        }
    }

    @media (max-width: 360px) {
        :root {
            --vinyl-size: 100px;
        }
    }
</style>
