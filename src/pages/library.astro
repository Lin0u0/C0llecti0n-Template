---
import Layout from "../layouts/Layout.astro";
import Bookshelf from "../components/Bookshelf.astro";
import NavMenu from "../components/NavMenu.astro";
import FilterToggle from "../components/FilterToggle.astro";
import SortToggle from "../components/SortToggle.astro";
import StatusFilter from "../components/StatusFilter.astro";
import SearchButton from "../components/SearchButton.astro";
import booksData from "../data/books.json";
import type { Book } from "../types";
import { splitBySlash, extractFilterOptions, extractNumericOptions, getAddedYear } from "../utils/filters";

// Type assertion and sort
const books: Book[] = booksData.map((b) => ({
    ...b,
    status: b.status as Book["status"],
})).sort(
    (a, b) =>
        new Date(b.addedDate || 0).getTime() -
        new Date(a.addedDate || 0).getTime(),
);

// Extract filter options
const authors = extractFilterOptions(books, (b) => b.author);
const years = extractNumericOptions(books, (b) => b.year);
const countries = extractFilterOptions(books, (b) => b.country);
const addedYears = [...new Set(books.map((b) => getAddedYear(b.addedDate)))].filter(Boolean).sort((a, b) => Number(b) - Number(a));
---

<Layout
    title="Library | Lin0u0"
    description="Book Collection"
    totalCount={books.length}
>
    <div class="page-container">
        <header class="page-header">
            <h1 class="page-title">Library</h1>
            <NavMenu currentPage="library" />
        </header>

        <div class="filters-section">
            <div class="filters-toolbar">
                <FilterToggle />
                <div class="toolbar-right">
                    <SearchButton />
                    <SortToggle showRating={true} />
                </div>
            </div>

            <div class="collapsible-filters" data-expanded="false">
                <div class="collapsible-inner">
                    <div class="filter-group">
                        <span class="filter-label">状态</span>
                        <StatusFilter type="book" />
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">添加时间</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="added"
                                data-value="all">全部</button
                            >
                            {
                                addedYears.map((year) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="added"
                                        data-value={year}
                                    >
                                        {year}
                                    </button>
                                ))
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">出版年份</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="year"
                                data-value="all">全部</button
                            >
                            {
                                years.map((year) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="year"
                                        data-value={year}
                                    >
                                        {year}
                                    </button>
                                ))
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">作者</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="author"
                                data-value="all">全部</button
                            >
                            {
                                authors.map((author) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="author"
                                        data-value={author}
                                    >
                                        {author}
                                    </button>
                                ))
                            }
                        </div>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">国家/地区</span>
                        <div class="filter-options">
                            <button
                                class="filter-chip active"
                                data-filter-type="country"
                                data-value="all">全部</button
                            >
                            {
                                countries.map((country) => (
                                    <button
                                        class="filter-chip"
                                        data-filter-type="country"
                                        data-value={country}
                                    >
                                        {country}
                                    </button>
                                ))
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="books-grid">
            <Bookshelf books={books} variant="grid" />
        </div>
    </div>
</Layout>

<script>
    import { initFilterSystem } from "../scripts/filter-system";

    initFilterSystem({
        itemSelector: ".book-spine",
        containerSelector: ".books-container",
        statsDisplayId: "stats-display",
        filterTypes: ["year", "author", "added", "country", "status"],
    });
</script>

<style>
    .filters-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-md);
    }

    .toolbar-right {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        flex-shrink: 0;
    }

    @media (max-width: 480px) {
        .filters-toolbar {
            gap: var(--space-sm);
        }
    }
</style>
