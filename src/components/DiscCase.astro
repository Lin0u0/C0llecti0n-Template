---
import { Image } from "astro:assets";
import { getCoverImage } from "../utils/images";
import type { Media } from "../types";

interface Props extends Media {}

const {
  title,
  director,
  cover,
  type,
  rating,
  status = "completed",
  id,
  year,
  addedDate,
  country,
  notes,
} = Astro.props;

const typeIcon = type === "movie" ? "ðŸŽ¬" : "ðŸ“º";
const isWatching = status === "watching";
const coverImage = getCoverImage(cover);
---

<button
  class="disc-case focus-ring"
  data-disc-id={id}
  data-title={title}
  data-director={director}
  data-cover={cover}
  data-type={type}
  data-rating={rating}
  data-status={status}
  data-year={year}
  data-added-date={addedDate}
  data-country={country}
  data-notes={notes}
  aria-label={`${title}${director ? ` directed by ${director}` : ""}`}
>
  <!-- Disc visible at top -->
  <div class="disc disc-surface">
    <div class="disc-center"></div>
  </div>

  <!-- Case cover -->
  <div class="case-cover">
    <div class="cover-skeleton"></div>
    {
      coverImage ? (
        <Image
          src={coverImage}
          alt={title}
          class="cover-image"
          width={240}
          loading="lazy"
        />
      ) : cover ? (
        <img src={cover} alt={title} class="cover-image" loading="lazy" />
      ) : (
        <div class="cover-placeholder">
          <span class="type-icon">{typeIcon}</span>
          <span class="placeholder-title">{title}</span>
        </div>
      )
    }

    {isWatching && <div class="watching-ribbon" />}
  </div>

  <!-- Case spine -->
  <div class="case-spine"></div>
</button>

<script>
  // Handle image load for reveal animation - works with lazy loading
  function handleDiscImageLoad(img: HTMLImageElement) {
    const skeleton = img.parentElement?.querySelector(".cover-skeleton");
    img.classList.add("loaded");
    skeleton?.classList.add("loaded");
  }

  // Set up load handlers for all disc case images
  function initDiscImages() {
    document.querySelectorAll(".disc-case .cover-image").forEach((img) => {
      const imgEl = img as HTMLImageElement;

      // If already loaded (cached), show immediately
      if (imgEl.complete && imgEl.naturalHeight !== 0) {
        handleDiscImageLoad(imgEl);
      } else {
        // Wait for load event
        imgEl.addEventListener("load", () => handleDiscImageLoad(imgEl), {
          once: true,
        });
      }
    });
  }

  // Run on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initDiscImages);
  } else {
    initDiscImages();
  }
</script>

<style>
  .disc-case {
    position: relative;
    width: var(--disc-size, 120px);
    height: calc(var(--disc-size, 120px) * 1.4);
    flex-shrink: 0;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: transform var(--transition-normal);
  }

  @media (hover: hover) {
    .disc-case:hover {
      transform: translateY(-4px) scale(1.02);
    }
  }

  /* Disc peeking from top - improved with rainbow effect */
  .disc {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    aspect-ratio: 1;
    border-radius: 50%;
    z-index: 0;
    transition: transform var(--transition-normal);
    /* Rainbow reflection effect */
    background:
      radial-gradient(circle at 50% 50%, #ddd 0%, #fff 100%),
      radial-gradient(circle at center, #d0d0d0 0%, #a0a0a0 30%, #808080 100%);
    box-shadow:
      0 2px 8px rgba(0, 0, 0, 0.4),
      inset 0 0 10px rgba(255, 255, 255, 0.1);
    overflow: hidden;
  }

  /* Data track rings */
  .disc::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: repeating-radial-gradient(
      circle at center,
      transparent 25%,
      rgba(0, 0, 0, 0.03) 25.5%,
      transparent 26%
    );
    pointer-events: none;
  }

  @media (hover: hover) {
    .disc-case:hover .disc {
      transform: translateX(-50%) translateY(-10px) rotate(8deg);
    }
  }

  .disc-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 25%;
    height: 25%;
    border-radius: 50%;
    background: conic-gradient(
      from 0deg at 50% 50%,
      rgba(255, 0, 128, 0.5) 0deg,
      rgba(128, 0, 255, 0.5) 60deg,
      rgba(0, 128, 255, 0.5) 120deg,
      rgba(0, 255, 128, 0.5) 180deg,
      rgba(255, 255, 0, 0.5) 240deg,
      rgba(255, 128, 0, 0.5) 300deg,
      rgba(255, 0, 128, 0.5) 360deg
    );
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow:
      inset 0 2px 4px rgba(255, 255, 255, 0.5),
      inset 0 -1px 1px rgba(255, 255, 255, 0.3);
  }

  .disc-type {
    font-size: 0.85rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  /* Case cover */
  .case-cover {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: var(--border-radius-sm);
    overflow: hidden;
    z-index: 1;
    background: #1a1a1a;
    box-shadow:
      0 4px 16px rgba(0, 0, 0, 0.5),
      inset 0 1px 1px rgba(255, 255, 255, 0.05);
  }

  /* Skeleton loading */
  .cover-skeleton {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      110deg,
      #1a1a1a 0%,
      #1a1a1a 40%,
      rgba(255, 255, 255, 0.08) 50%,
      #1a1a1a 60%,
      #1a1a1a 100%
    );
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s infinite linear;
    z-index: 2;
    opacity: 1;
    transition: opacity 0.3s ease-out;
  }

  .cover-skeleton.loaded {
    opacity: 0;
    pointer-events: none;
    /* Delay fadeout so image has time to appear first */
    transition-delay: 0.15s;
  }

  @keyframes skeleton-shimmer {
    0% {
      background-position: 100% 0;
    }
    100% {
      background-position: -100% 0;
    }
  }

  .cover-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.3s ease-out;
  }

  .cover-image.loaded {
    opacity: 1;
  }

  .cover-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-sm);
    background: var(--bg-shelf);
    border: 1px dashed var(--border-subtle);
    text-align: center;
  }

  .type-icon {
    font-size: 2rem;
    margin-bottom: var(--space-sm);
    opacity: 0.6;
  }

  .placeholder-title {
    font-family: var(--font-body);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    line-height: 1.3;
    opacity: 0.8;
  }

  /* Watching Ribbon - Elegant deep red */
  .watching-ribbon {
    position: absolute;
    top: -2px;
    right: 12px;
    width: 10px;
    height: 45px;
    /* Deep burgundy/wine red gradient */
    background: linear-gradient(
      to right,
      #7d2d3c 0%,
      #9b3a4a 50%,
      #7d2d3c 100%
    );
    z-index: 10;
    box-shadow:
      1px 1px 2px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
    clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 85%, 0 100%);
    transition: transform var(--transition-normal);
  }

  /* Light mode ribbon - Softer rose */
  :global([data-theme="light"]) .watching-ribbon {
    background: linear-gradient(
      to right,
      #a04050 0%,
      #b85060 50%,
      #a04050 100%
    );
  }

  @media (hover: hover) {
    .disc-case:hover .watching-ribbon {
      transform: translateY(-4px);
    }
  }

  /* Case spine */
  .case-spine {
    position: absolute;
    left: -3px;
    top: 10%;
    bottom: 10%;
    width: 4px;
    background: linear-gradient(180deg, #444 0%, #222 50%, #444 100%);
    border-radius: 2px 0 0 2px;
    box-shadow: -2px 0 4px rgba(0, 0, 0, 0.3);
    z-index: 2;
  }

  /* Plastic sheen effect */
  .case-cover::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.1) 0%,
      transparent 40%
    );
    pointer-events: none;
  }
</style>
